@startuml Sustainable Classroom LMS - Technical Workflow
!theme plain
skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam sequenceMessageAlign center

title Sustainable Classroom LMS - Complete Technical Architecture & Workflow

' Define actors and participants
actor "Admin" as admin #FFB6C1
actor "Teacher" as teacher #87CEEB
actor "Student" as student #98FB98

' Frontend participants
participant "Login UI" as authUI
participant "Admin Dashboard" as adminUI
participant "Teacher Dashboard" as teacherUI
participant "Student Dashboard" as studentUI
participant "Module Builder" as moduleBuilder
participant "Module Learning" as moduleLearning
participant "Test Interface" as testUI
participant "Time Tracker" as timeTracker

' Backend participants
participant "Auth API" as authAPI
participant "User API" as userAPI
participant "Module API" as moduleAPI
participant "Progress API" as progressAPI
participant "Test API" as testAPI
participant "Notification Service" as notifService
participant "File Handler" as fileHandler
participant "Time API" as timeAPI

' Database participants
database "Users DB" as usersDB
database "Modules DB" as modulesDB
database "Tests DB" as testsDB
database "Submissions DB" as submissionsDB
database "Completion DB" as completionDB
database "Time DB" as timeDB
database "Notifications DB" as notifDB

' External services
participant "Cloudinary" as cloudinary
participant "Mailjet" as mailjet
participant "JWT" as jwt

' ============================================
' AUTHENTICATION FLOW
' ============================================
note over admin, student
  **AUTHENTICATION WORKFLOW**
  Role-based access control with JWT tokens
end note

student -> authUI : 1. Login (email + password)
authUI -> authAPI : POST /api/login
authAPI -> usersDB : Verify credentials (bcrypt)
usersDB --> authAPI : User data + role
authAPI -> jwt : Generate token
jwt --> authAPI : JWT token
authAPI --> authUI : Token + user info
authUI -> studentUI : Redirect to dashboard

teacher -> authUI : Login as teacher
authUI -> authAPI : POST /api/teacher/login
authAPI -> usersDB : Verify teacher credentials
usersDB --> authAPI : Teacher profile
authAPI --> teacherUI : Authenticated session

' ============================================
' STUDENT LEARNING WORKFLOW
' ============================================
note over student, db
  **STUDENT LEARNING WORKFLOW**
  Module consumption, progress tracking, and assessments
end note

student -> studentUI : View dashboard
studentUI -> progressAPI : GET /api/student/stats
progressAPI -> modulesDB : Fetch assigned modules
progressAPI -> completionDB : Calculate progress
completionDB --> progressAPI : Completed/Total modules
progressAPI --> studentUI : Display stats (modules completed, streak)

student -> studentUI : Browse courses
studentUI -> moduleAPI : GET /api/student/my-modules
moduleAPI -> usersDB : Get student section
moduleAPI -> modulesDB : Filter modules by section
modulesDB --> moduleAPI : Module list (ECE A, IT A, etc.)
moduleAPI --> studentUI : Display available modules

student -> moduleLearning : Select module
moduleLearning -> moduleAPI : GET /api/student/module/:id
moduleAPI -> modulesDB : Fetch module steps
moduleAPI -> completionDB : Get completed steps
completionDB --> moduleAPI : Step completion status
moduleAPI --> moduleLearning : Steps + progress

alt Video Content
    moduleLearning -> videoPlayer : Load video step
    videoPlayer -> cloudinary : Fetch video URL
    cloudinary --> videoPlayer : Streaming video
    videoPlayer --> student : Display video
end

alt Text/Code Content
    moduleLearning --> student : Display content inline
end

student -> moduleLearning : Mark step complete
moduleLearning -> progressAPI : POST /api/student/module/:id/complete
progressAPI -> completionDB : INSERT step completion
completionDB -> completionDB : Check if all steps done

alt All Steps Complete
    completionDB -> modulesDB : Mark module complete
    progressAPI -> notifService : Trigger notifications
    notifService -> notifDB : Create teacher notification
    notifService -> mailjet : Send completion email
    mailjet -> teacher : Email: "Student completed module"
    notifService -> notifDB : Create student achievement
    notifDB --> studentUI : Show "Module Completed!" badge
end

progressAPI --> moduleLearning : Success + updated stats

' ============================================
' TIME TRACKING WORKFLOW
' ============================================
note over timeTracker, timeDB
  **AUTOMATIC TIME TRACKING**
  Background session tracking with database persistence
end note

studentUI -> timeTracker : Component mounts
timeTracker -> timeAPI : POST /api/student/start-session
timeAPI -> timeDB : Create/update session
timeTracker -> timeAPI : GET /api/student/daily-time
timeAPI -> timeDB : Fetch today's total
timeDB --> timeTracker : Total seconds studied today

loop Every 30 seconds
    timeTracker -> timeAPI : POST /api/student/update-time
    timeAPI -> timeDB : Increment study time
    timeDB --> timeTracker : Confirmation
end

alt Break Reminder (Every 25 min)
    timeTracker --> student : Show break notification
    student -> timeTracker : Take/Skip break
end

student -> studentUI : Navigate away
timeTracker -> timeAPI : POST /api/student/update-time (final)
timeAPI -> timeDB : Save session time

' ============================================
' TEACHER WORKFLOW - CONTENT CREATION
' ============================================
note over teacher, cloudinary
  **TEACHER CONTENT CREATION WORKFLOW**
  Module publishing with multimedia support
end note

teacher -> teacherUI : Create new module
teacherUI -> moduleBuilder : Open module builder
teacher -> moduleBuilder : Add module metadata\n(title, subject, section)

loop For each step
    alt Video Content
        teacher -> moduleBuilder : Upload video file
        moduleBuilder -> fileHandler : POST /api/upload/video
        fileHandler -> cloudinary : Upload to cloud
        cloudinary --> fileHandler : Video URL + CDN link
        fileHandler --> moduleBuilder : Store URL
    end
    
    alt Text/Code Content
        teacher -> moduleBuilder : Enter markdown/code
        moduleBuilder -> moduleBuilder : Store locally
    end
end

teacher -> moduleBuilder : Publish module
moduleBuilder -> moduleAPI : POST /api/teacher/modules
moduleAPI -> modulesDB : INSERT module + steps
modulesDB -> modulesDB : Set step_count

moduleAPI -> userAPI : GET /api/students by section
userAPI -> usersDB : Fetch students in section
usersDB --> moduleAPI : Student list

moduleAPI -> notifService : Trigger MODULE_PUBLISHED
notifService -> notifDB : Create notifications for all students
notifService -> mailjet : Send email to each student
mailjet -> student : "New module published: [Title]"

moduleAPI --> moduleBuilder : Success confirmation
moduleBuilder --> teacherUI : Show in module list

' ============================================
' TEACHER WORKFLOW - MONITORING
' ============================================
note over teacherUI, analyticsAPI
  **TEACHER MONITORING WORKFLOW**
  Real-time student progress tracking
end note

teacher -> teacherUI : View student progress
teacherUI -> analyticsAPI : GET /api/teacher/student-progress
analyticsAPI -> usersDB : Get teacher's sections
analyticsAPI -> modulesDB : Get teacher's modules
analyticsAPI -> completionDB : Aggregate completion data
completionDB --> analyticsAPI : Progress by student
analyticsAPI --> teacherUI : Display progress table

teacher -> notifUI : Check notifications
notifUI -> notifService : GET /api/notifications/unread
notifService -> notifDB : Fetch unread notifications
notifDB --> notifUI : List (student completions, test submissions)

teacher -> notifUI : Click notification
notifUI -> notifService : PUT /api/notifications/:id/read
notifService -> notifDB : Mark as read
notifDB --> notifUI : Update badge count

' ============================================
' ASSESSMENT WORKFLOW
' ============================================
note over teacher, submissionsDB
  **ASSESSMENT CREATION & GRADING WORKFLOW**
  MCQ tests and coding problem management
end note

teacher -> teacherUI : Create MCQ test
teacherUI -> testAPI : POST /api/teacher/mcq-tests
testAPI -> testsDB : Store test + questions
testsDB -> testsDB : Set deadline

testAPI -> userAPI : GET /api/students by section
userAPI -> usersDB : Fetch eligible students
testAPI -> notifService : Trigger TEST_ASSIGNED
notifService -> notifDB : Create student notifications
notifService -> mailjet : Email all students
mailjet -> student : "New test assigned: [Title]"

student -> studentUI : View assigned tests
studentUI -> testAPI : GET /api/student/tests
testAPI -> testsDB : Fetch tests for section
testsDB --> studentUI : Available tests + deadlines

student -> testUI : Take test
testUI -> testAPI : GET /api/student/test/:id
testAPI -> testsDB : Fetch questions
testsDB --> testUI : Display test questions

student -> testUI : Submit answers
testUI -> testAPI : POST /api/student/test/:id/submit
testAPI -> submissionsDB : Store submission
testAPI -> testAPI : Auto-calculate score
submissionsDB -> testsDB : Update submission status

testAPI -> notifService : Trigger TEST_SUBMITTED
notifService -> notifDB : Notify teacher
notifService -> mailjet : Email teacher
mailjet -> teacher : "Student submitted test"

alt Manual Grading Required
    teacher -> teacherUI : View submissions
    teacherUI -> testAPI : GET /api/teacher/submissions
    testAPI -> submissionsDB : Fetch all submissions
    submissionsDB --> teacherUI : Display list
    
    teacher -> teacherUI : Grade submission
    teacherUI -> testAPI : POST /api/teacher/grade
    testAPI -> submissionsDB : Update score
    testAPI -> notifService : Trigger GRADE_POSTED
    notifService -> notifDB : Notify student
    notifService -> mailjet : Email student
    mailjet -> student : "Your grade is ready: [Score]"
end

' ============================================
' ADMIN WORKFLOW
' ============================================
note over admin, usersDB
  **ADMIN USER MANAGEMENT WORKFLOW**
  Bulk user registration and system oversight
end note

admin -> adminUI : Upload CSV (students/teachers)
adminUI -> userAPI : POST /api/admin/bulk-register
userAPI -> usersDB : Batch INSERT users
usersDB -> usersDB : Hash passwords (bcrypt)
userAPI -> notifService : Trigger ACCOUNT_CREATED (bulk)
notifService -> mailjet : Send welcome emails
mailjet -> teacher : Account credentials
mailjet -> student : Account credentials

admin -> adminUI : View all users
adminUI -> userAPI : GET /api/admin/users
userAPI -> usersDB : Fetch all users
usersDB --> adminUI : Display user table

admin -> adminUI : Manage sections/subjects
adminUI -> userAPI : POST /api/admin/update-user
userAPI -> usersDB : UPDATE user data

' ============================================
' NOTIFICATION SYSTEM
' ============================================
note over notifService, mailjet
  **COMPREHENSIVE NOTIFICATION SYSTEM**
  Real-time in-app + email notifications
end note

notifService -> notifService : Event triggered
notifService -> notifDB : Create in-app notification
notifService -> mailjet : Send email via API

mailjet -> mailjet : Email delivery queue
mailjet --> notifService : Delivery status

loop Supported Events
    note right of notifService
      - ACCOUNT_CREATED
      - MODULE_PUBLISHED
      - MODULE_COMPLETED
      - TEST_ASSIGNED
      - TEST_SUBMITTED
      - GRADE_POSTED
      - DEADLINE_REMINDER
    end note
end

' ============================================
' DATA PERSISTENCE & INTEGRITY
' ============================================
note over usersDB, notifDB
  **DATABASE SCHEMA & RELATIONSHIPS**
  PostgreSQL with views, triggers, and indexes
  
  **Foreign Key Relationships:**
  - Modules.teacher_id → Users.id
  - Completion.module_id → Modules.id
  - Completion.student_id → Users.id
  - Submissions.student_id → Users.id
  - Submissions.test_id → Tests.id
  - Time.student_id → Users.id
  - Notifications.recipient_id → Users.id
end note

note right of completionDB
  **Module Completion Table**
  Unique constraint:
  (module_id, student_id, step_index)
  
  Tracks step-level progress
  with timestamps
end note

note right of timeDB
  **Daily Study Time Table**
  Daily aggregation:
  (student_id, study_date)
  
  Persistent session tracking
  survives page navigation
end note

' ============================================
' SECURITY & PERFORMANCE
' ============================================
note over jwt, timeDB
  **SECURITY MEASURES**
  - JWT token authentication
  - bcrypt password hashing
  - Role-based access control (RBAC)
  - SSL/TLS database connections
  - Environment variable secrets
  - CORS protection
end note

note over cloudinary, mailjet
  **PERFORMANCE OPTIMIZATIONS**
  - Cloudinary CDN for media delivery
  - Database connection pooling
  - Indexed queries (student_id, module_id)
  - Lazy loading for module steps
  - Efficient progress aggregation
  - Background notification processing
end note

@enduml
